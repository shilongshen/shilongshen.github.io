# Arbitrary Style Transfer in Real-time with Adaptive Instance Normalization


è¯¥æ–‡æå‡ºäº†ä¸€ç§ç®€å•ä½†é«˜æ•ˆçš„å®æ—¶ï¼ˆ**è½¬æ¢é€Ÿåº¦æ›´å¿«**ï¼‰çš„èƒ½è¿›è¡Œ**ä»»æ„é£æ ¼**è¿ç§»çš„æ¨¡å‹ã€‚è¯¥æ¨¡å‹çš„æ ¸å¿ƒä¸ºadaptive instance normalization (AdaIN) layerï¼Œ**AdaIN**èƒ½å¤Ÿå¯¹é½content feature ä¸style featureçš„å‡å€¼å’Œæ–¹å·®ã€‚ 

#### 1 Introduction

æ·±åº¦ç¥ç»ç½‘ç»œèƒ½å¤Ÿå°†å›¾åƒçš„å†…å®¹ä»¥åŠé£æ ¼ä¿¡æ¯è¿›è¡Œç¼–ç ï¼Œè€Œä¸”å›¾åƒçš„å†…å®¹å’Œé£æ ¼æ˜¯å¯åˆ†ç¦»çš„ï¼Œå› æ­¤å¯ä»¥å®ç°åœ¨ä¿å­˜å›¾åƒå†…å®¹çš„åŒæ—¶å¯¹å›¾åƒçš„é£æ ¼è¿›è¡Œæ”¹å˜ã€‚

ç°å­˜çš„æ–¹æ³•å­˜åœ¨ä¸¤ä¸ªå¼Šç«¯ï¼š1.èƒ½å¤Ÿå®ç°ä»»æ„é£æ ¼çš„è¿ç§»ï¼Œä½†æ˜¯é€Ÿåº¦è¾ƒæ…¢ã€‚2.é€Ÿåº¦è¾ƒå¿«ï¼Œä½†æ˜¯åªèƒ½å¤Ÿå®ç°å•ä¸€é£æ ¼çš„è¿ç§»ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­å®ç°äº†é€Ÿåº¦å¿«ä¸”èƒ½å¤Ÿå®ç°ä»»æ„é£æ ¼è½¬æ¢ã€‚

AdaINç”±instance normalization (IN)æ‰€å¯å‘ã€‚INåœ¨feed-forwardé£æ ¼è¿ç§»ä¸­æ˜¯ååˆ†é«˜æ•ˆçš„ï¼ŒINçš„ä½œç”¨å¯ä»¥è§£é‡Šä¸ºï¼š**INé€šè¿‡å½’ä¸€åŒ–åŒ…å«å›¾åƒé£æ ¼ä¿¡æ¯çš„feature statisticsï¼ˆç‰¹å¾çš„ç»Ÿè®¡ç‰¹æ€§ï¼Œä¾‹å¦‚å‡å€¼å’Œæ–¹å·®ï¼‰æ¥è¿›è¡Œé£æ ¼å½’ä¸€åŒ–ã€‚**

AdaINsæ˜¯INçš„æ‹“å±•ï¼Œå…¶ä»¥å†…å®¹å’Œé£æ ¼ä½œä¸ºè¾“å…¥ï¼Œé€šè¿‡è°ƒæ•´å†…å®¹çš„å‡å€¼å’Œæ–¹å·®æ¥åŒ¹é…é£æ ¼è¾“å…¥dçš„å‡å€¼å’Œæ–¹å·®ã€‚

#### 2 related work

##### style transfer

â€‹		é£æ ¼è¿ç§»é—®é¢˜èµ·æºäºnon-photo-realistic renderingï¼ˆéçœŸå®æ€§æ¸²æŸ“ï¼šé€šè¿‡é£æ ¼å½¢å¼çš„è‰ºæœ¯åŒ–åŠ å·¥ã€‚ç›¸å¯¹çš„çœŸå®æ€§æ¸²æŸ“å¼ºè°ƒå…¶è¾“å‡ºçš„å¤–è§‚å°½å¯èƒ½çš„ä¸ç›®æ ‡å›¾åƒç›¸åŒã€‚ï¼‰,å¹¶ä¸”ä¸çº¹ç†åˆæˆå’Œè½¬ç§»å¯†åˆ‡ç›¸å…³ã€‚ä¸€äº›æ—©æœŸä½¿ç”¨çš„æ–¹æ³•åŒ…æ‹¬äº†ç›´æ–¹å›¾åŒ¹é…å’Œéå‚æ•°é‡‡æ ·ã€‚è¿™äº›æ–¹æ³•é€šå¸¸ä¾èµ–äºä½å±‚æ¬¡çš„ç»Ÿè®¡ç‰¹æ€§å¹¶ä¸”ä¸èƒ½å¤Ÿå¾ˆå¥½çš„æ•è·è¯­ä¹‰ç»“æ„ä¿¡æ¯ã€‚Grayç­‰äººé¦–æ¬¡é€šè¿‡åœ¨æ·±åº¦ç¥ç»ç½‘ç»œä¸­åŒ¹é…å·ç§¯å±‚çš„ç»Ÿè®¡ç‰¹æ€§æ¥è¿›è¡Œé£æ ¼è¿ç§»ï¼Œå¹¶è¾¾åˆ°äº†ååˆ†å‡ºè‰²çš„æ•ˆæœã€‚

â€‹		Grayç­‰äººæå‡ºçš„ç½‘ç»œæ¡†æ¶ç”±äºéœ€è¦æœ€å°åŒ–å†…å®¹æŸå¤±å‡½æ•°å’Œé£æ ¼æŸå¤±å‡½æ•°æ¥è¿­ä»£æ›´æ–°å›¾åƒï¼Œå› æ­¤ä¼˜åŒ–çš„è¿‡ç¨‹ååˆ†çš„ç¼“æ…¢ï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­å¸¸å¸¸éœ€è¦è¾ƒé•¿çš„æ—¶é—´æ¥å¤„ç†å›¾åƒï¼ˆæ–‡ä¸­å¹¶æ²¡æœ‰é‡‡ç”¨å¸¸ç”¨çš„æ¢¯åº¦ä¸‹é™çš„æ–¹æ³•ï¼Œé‡‡ç”¨çš„æ˜¯L-BFGSçš„ä¼˜åŒ–ç®—æ³•ï¼Œå…¶å®æœ¬èº«è¿™ä¸ªé£æ ¼è½¬æ¢**åªæ˜¯åˆ©ç”¨çš„VGGç½‘ç»œè¿›è¡Œç‰¹å¾æå–**ï¼Œå®é™…ä¸ŠL-BFGSä¼˜åŒ–çš„æ˜¯ä»ä¸€å¼ ç”±ç™½å™ªå£°ç»„æˆçš„å›¾ç‰‡ï¼Œæœ€ç»ˆæ ¹æ®å®šä¹‰çš„æŸå¤±ä¼˜åŒ–å¾—åˆ°æœ€ç»ˆçš„é£æ ¼è½¬æ¢å›¾ç‰‡ï¼‰ã€‚ä¸€ç§å¸¸è§çš„è§£å†³ä¸ºä½¿ç”¨è®­ç»ƒåçš„å‰é¦ˆç¥ç»ç½‘ç»œå°†ä¼˜åŒ–è¿‡ç¨‹æ›¿ä»£ï¼Œè¿™èƒ½å¤Ÿæå¿«çš„æå‡å¤„ç†å›¾åƒçš„é€Ÿåº¦ï¼Œå®ç°å®æ—¶çš„è½¬æ¢ã€‚ç„¶è€Œè¿™äº›åŸºäºå‰é¦ˆç½‘ç»œçš„æ–¹æ³•å­˜åœ¨ç€å±€é™æ€§ï¼šä¸€ä¸ªç½‘ç»œæ¡†æ¶åªèƒ½å¤Ÿç”Ÿæˆæœ‰é™é£æ ¼çš„å›¾åƒã€‚

...

------

å„ç§å½’ä¸€åŒ–æ–¹æ³•å›¾ä¾‹

![](https://gitee.com/shilongshen/image-bad/raw/master/20200728093230.png)

#### 3 Background

> å¦‚æœä¸€ä¸ªæœºå™¨å­¦ä¹ ç®—æ³•åœ¨ç¼©æ”¾å…¨éƒ¨æˆ–éƒ¨åˆ†ç‰¹å¾åä¸å½±å“å®ƒçš„å®ƒçš„å­¦ä¹ å’Œé¢„æµ‹ï¼Œæˆ‘ä»¬å°±ç§°è¯¥ç®—æ³•å…·æœ‰**å°ºåº¦ä¸å˜æ€§**ã€‚
>
> ä»ç†è®ºä¸Šï¼Œç¥ç»ç½‘ç»œåº”è¯¥å…·æœ‰å°ºåº¦ä¸å˜æ€§ï¼Œå¯ä»¥é€šè¿‡å‚æ•°çš„è°ƒæ•´æ¥é€‚åº”ä¸åŒç‰¹å¾çš„å°ºåº¦ï¼ä½†**å°ºåº¦ä¸åŒçš„è¾“å…¥ç‰¹å¾ä¼šå¢åŠ è®­ç»ƒéš¾åº¦**ï¼å‡è®¾ä¸€ä¸ªåªæœ‰ä¸€å±‚çš„ç½‘ç»œğ‘¦ = tanh(ğ‘¤1ğ‘¥1 + ğ‘¤2ğ‘¥2 + ğ‘)ï¼Œå…¶ä¸­ğ‘¥1 âˆˆ [0, 10]ï¼Œğ‘¥2 âˆˆ [0, 1]ï¼ä¹‹å‰æˆ‘ä»¬æåˆ°tanh å‡½æ•°çš„å¯¼æ•°åœ¨åŒºé—´[âˆ’2, 2] ä¸Šæ˜¯æ•æ„Ÿçš„ï¼Œå…¶ä½™çš„å¯¼æ•°æ¥è¿‘äº0ï¼å› æ­¤ï¼Œå¦‚æœğ‘¤1ğ‘¥1 + ğ‘¤2ğ‘¥2 + ğ‘ è¿‡å¤§æˆ–è¿‡å°ï¼Œéƒ½ä¼šå¯¼è‡´æ¢¯åº¦è¿‡å°ï¼Œéš¾ä»¥è®­ç»ƒï¼ä¸ºäº†æé«˜è®­ç»ƒæ•ˆç‡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ğ‘¤1ğ‘¥1 + ğ‘¤2ğ‘¥2 + ğ‘ åœ¨[âˆ’2, 2] åŒºé—´ï¼Œå› æ­¤éœ€è¦å°†ğ‘¤1 è®¾å¾—å°ä¸€ç‚¹ï¼Œæ¯”å¦‚åœ¨[âˆ’0.1, 0.1] ä¹‹é—´ï¼å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœæ•°æ®ç»´æ•°å¾ˆå¤šæ—¶ï¼Œæˆ‘ä»¬å¾ˆéš¾è¿™æ ·ç²¾å¿ƒå»é€‰æ‹©æ¯ä¸€ä¸ªå‚æ•°ï¼å› æ­¤ï¼Œ**å¦‚æœæ¯ä¸€ä¸ªç‰¹å¾çš„å°ºåº¦ç›¸ä¼¼ï¼Œæ¯”å¦‚[0, 1] æˆ–è€…[âˆ’1, 1]ï¼Œæˆ‘ä»¬å°±ä¸å¤ªéœ€è¦åŒºåˆ«å¯¹å¾…æ¯ä¸€ä¸ªå‚æ•°ï¼Œä»è€Œå‡å°‘äººå·¥å¹²é¢„**ã€‚
>
> <u>é™¤äº†å‚æ•°åˆå§‹åŒ–æ¯”è¾ƒå›°éš¾å¤–ï¼Œä¸åŒè¾“å…¥ç‰¹å¾çš„å°ºåº¦å·®å¼‚æ¯”è¾ƒå¤§æ—¶ï¼Œæ¢¯åº¦ä¸‹é™æ³•çš„æ•ˆç‡ä¹Ÿä¼šå—åˆ°å½±å“</u>ã€‚
>
> å°ºåº¦ä¸åŒä¼šé€ æˆåœ¨å¤§å¤šæ•°ä½ç½®ä¸Šçš„æ¢¯åº¦æ–¹å‘å¹¶ä¸æ˜¯æœ€ä¼˜çš„æœç´¢æ–¹å‘ï¼å½“ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•å¯»æ±‚æœ€ä¼˜è§£æ—¶ï¼Œä¼šå¯¼è‡´éœ€è¦å¾ˆå¤šæ¬¡è¿­ä»£æ‰èƒ½æ”¶æ•›ï¼å¦‚æœæˆ‘ä»¬æŠŠæ•°æ®å½’ä¸€åŒ–ä¸ºç›¸åŒå°ºåº¦ï¼Œå¦‚å›¾7.9bæ‰€ç¤ºï¼Œå¤§éƒ¨åˆ†ä½ç½®çš„æ¢¯åº¦æ–¹å‘è¿‘ä¼¼äºæœ€ä¼˜æœç´¢æ–¹å‘ï¼è¿™æ ·ï¼Œåœ¨æ¢¯åº¦ä¸‹é™æ±‚è§£æ—¶ï¼Œæ¯ä¸€æ­¥æ¢¯åº¦çš„æ–¹å‘éƒ½åŸºæœ¬æŒ‡å‘æœ€å°å€¼ï¼Œè®­ç»ƒæ•ˆç‡ä¼šå¤§å¤§æé«˜
>
> ![](https://gitee.com/shilongshen/image-bad/raw/master/image/20200604092535.png)
>
> **å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰æ–¹æ³•æ³›æŒ‡æŠŠæ•°æ®ç‰¹å¾è½¬åŒ–ä¸ºç›¸åŒå°ºåº¦çš„æ–¹æ³•**ã€‚
>
> ç¥ç»ç½‘ç»œä¸­å‡ ç§å¸¸ç”¨çš„å½’ä¸€åŒ–æ–¹æ³•ï¼š
>
> ###### æœ€å¤§æœ€å°å€¼å½’ä¸€åŒ–
>
> ...
>
> ###### ç™½åŒ–
>
> ...
>
> ###### æ ‡å‡†åŒ–
>
> å°†æ¯ä¸€ç»´çš„ç‰¹å¾éƒ½è°ƒæ•´ä¸ºå‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1.å‡è®¾æœ‰$N$ä¸ªæ ·æœ¬$\{ \pmb{x}^{(n)} \}_{n=1}^N$,å¯¹äºæ¯ä¸€ç»´ç‰¹å¾ï¼Œæˆ‘ä»¬å…ˆè®¡ç®—å®ƒçš„å‡å€¼å’Œæ–¹å·®ï¼š
> $$
> \mu=\frac{1}{N}\sum_{n=1}^Nx^{(n)}\\
> \sigma^2=\frac{1}{N}\sum_{n=1}^N(x^{(n)}-\mu)
> $$
> ç„¶åå¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–
> $$
> \hat{x}^n=\frac{x^{(n)}-\mu}{\sigma}
> $$
>
> ###### å°†å½’ä¸€åŒ–åº”ç”¨åˆ°ç¥ç»ç½‘ç»œä¸­ï¼š
>
> ###### é€å±‚å½’ä¸€åŒ–
>
> é€å±‚å½’ä¸€åŒ–ï¼ˆLayer-wise Normalizationï¼‰æ˜¯å°†ä¼ ç»Ÿæœºå™¨å­¦ä¹ ä¸­çš„æ•°æ®å½’ä¸€åŒ–æ–¹æ³•åº”ç”¨åˆ°æ·±åº¦ç¥ç»ç½‘ç»œä¸­ï¼Œå¯¹ç¥ç»ç½‘ç»œä¸­éšè—å±‚çš„è¾“å…¥è¿›è¡Œå½’ä¸€åŒ–ï¼Œä»è€Œä½¿å¾—ç½‘ç»œæ›´å®¹æ˜“è®­ç»ƒï¼
>
> ###### æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼ŒBNï¼‰
>
> æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼ŒBNï¼‰æ˜¯ä¸€ç§æœ‰æ•ˆçš„é€å±‚å½’ä¸€åŒ–ã€‚
>
> è®¾ç¥ç»ç½‘ç»œç¬¬$l$å±‚çš„è¾“å…¥ä¸º$a^{(l-1)}$,è¾“å‡ºä¸º$a^{(l)}$
> $$
> a^{(l)}=f(z^{(l)})=f(wa^{(l-1)}+b)
> $$
> å¯¹$z^{(l)}$å®æ–½å½’ä¸€åŒ–æ“ä½œï¼š
> $$
> \hat{z}^{(l)}=\frac{z^{(l)}-\mu[z^{(l)}]}{\sqrt{\sigma[z^{(l)}]+\epsilon}}
> $$
> $\mu[z^{(l)}]$è¡¨ç¤ºå‡å€¼ï¼Œ$\sigma^2[z^{(l)}]$è¡¨ç¤ºæ–¹å·®ã€‚$z^{(l)}$çš„æœŸæœ›å’Œæ–¹å·®é€šå¸¸æ˜¯åŸºäºå°æ‰¹é‡æ ·æœ¬çš„å‡å€¼å’Œæ–¹å·®è¿‘ä¼¼ä¼°è®¡ï¼Œç»™å®šä¸€ä¸ªåŒ…å«$K$ä¸ªæ ·æœ¬çš„å°æ‰¹é‡æ ·æœ¬é›†åˆï¼Œå‡å€¼å’Œæ–¹å·®ä¸ºï¼š
> $$
> \mu[z^{(l)}]=\frac{1}{K}\sum_{k=1}^Kz^{(k,l)}\\
> \sigma^2[z^{(l)}]=\frac{1}{K}\sum_{k=1}^K{\huge[}z^{(k,l)}-\mu[z^{(k,l)}]{\huge]}^2
> $$
> å¯¹å‡€è¾“å…¥ğ’›(ğ‘™) çš„æ ‡å‡†å½’ä¸€åŒ–ä¼šä½¿å¾—å…¶å–å€¼é›†ä¸­åˆ°0 é™„è¿‘ï¼Œå¦‚æœä½¿ç”¨Sigmoidæ¿€æ´»å‡½æ•°æ—¶ï¼Œè¿™ä¸ªå–å€¼åŒºé—´åˆšå¥½æ˜¯æ¥è¿‘çº¿æ€§å˜æ¢çš„åŒºé—´ï¼Œå‡å¼±äº†ç¥ç»ç½‘ç»œçš„éçº¿æ€§æ€§è´¨ï¼å› æ­¤ï¼Œä¸ºäº†ä½¿å¾—å½’ä¸€åŒ–ä¸å¯¹ç½‘ç»œçš„è¡¨ç¤ºèƒ½åŠ›é€ æˆè´Ÿé¢å½±å“ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª**é™„åŠ çš„ç¼©æ”¾å’Œå¹³ç§»å˜æ¢æ”¹å˜å–å€¼åŒºé—´**:
> $$
> \hat{z}^{(l)}=\gamma{\huge(}\frac{z^{(l)}-\mu[z^{(l)}]}{\sqrt{\sigma[z^{(l)}]+\epsilon}}{\huge)}+\beta
> $$
> ...
>
> 

##### 3.1 BN

ç»™å®šinput batch $x \in \mathbb{R}^{N\times C \times H \times W}$ï¼ˆç›¸å½“äºä¸Šè¿°çš„$z$ï¼‰ï¼Œ
$$
BN(x)=\gamma{\huge(}\frac{x-\mu{(x)}}{\sigma(x)}{\huge)}+\beta
$$

> $\mu(x)$å’Œ$\sigma(x)$å¦‚ä½•è®¡ç®—ï¼Ÿ
>
> å‡è®¾batchsize=Nï¼Œå³ä¸€æ¬¡è¾“å…¥Nå¼ å›¾ç‰‡ï¼Œå…¶ç»´åº¦ä¸º$x\in \mathbb{R}^{C\times H \times W}$ï¼Œç„¶åå°†$x$é‡æ„ä¸ºç»´åº¦ä¸º$x\in \mathbb{R}^{C\times (H \times W)}$ï¼Œç„¶åå°†Nå¼ å›¾ç‰‡è¿›è¡Œå åŠ ï¼Œ**æ²¿é€šé“æ–¹å‘è®¡ç®—å‡å€¼å’Œæ–¹å·®**ã€‚<u>Batch Normalizationæ˜¯æŒ‡Nå¼ å›¾ç‰‡çš„æ¯ä¸€å¼ å›¾ç‰‡çš„åŒä¸€ä¸ªé€šé“ä¸€èµ·è¿›è¡ŒNormalizationæ“ä½œ</u>ã€‚**BNæ³¨é‡å¯¹æ¯ä¸ªbatchè¿›è¡Œå½’ä¸€åŒ–ï¼Œä»è€Œä¿è¯æ•°æ®åˆ†å¸ƒçš„ä¸€è‡´æ€§**ã€‚ä½†æ˜¯BNå¯¹batchsizeçš„å¤§å°æ¯”è¾ƒæ•æ„Ÿï¼Œç”±äºæ¯æ¬¡è®¡ç®—å‡å€¼å’Œæ–¹å·®æ˜¯åœ¨ä¸€ä¸ªbatchä¸Šï¼Œæ‰€ä»¥å¦‚æœbatchsizeå¤ªå°ï¼Œåˆ™è®¡ç®—çš„å‡å€¼ã€æ–¹å·®ä¸è¶³ä»¥ä»£è¡¨æ•´ä¸ªæ•°æ®åˆ†å¸ƒï¼›
>
> 
>
> ![](https://gitee.com/shilongshen/image-bad/raw/master/image/20200604112046.png)

å…¶ä¸­æ¯ä¸€ä¸ªé€šé“ä¸Šçš„å‡å€¼å’Œæ–¹å·®çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š
$$
\mu_c(x)=\frac{1}{N}\sum_{n=1}^N{\huge[} \frac{1}{HW}\sum_{h=1}^H\sum_{w=1}^Wx_{nchw}  {\huge]}\\
\sigma_c(x)=\sqrt{ 
\frac{1}{N}\sum_{n=1}^N{\huge[} \frac{1}{HW}\sum_{h=1}^H\sum_{w=1}^W(x_{nchw}-\mu_{c}(x))^2  {\huge]}+\epsilon
}
$$


##### 3.2 IN

$$
IN(x)=\gamma{\huge(}\frac{x-\mu{(x)}}{\sigma(x)}{\huge)}+\beta
$$

å…¶ä¸­æ¯ä¸ªé€šé“ä¸Šçš„å‡å€¼å’Œæ–¹å·®è®¡ç®—å…¬å¼å¦‚ä¸‹(Instance Normalizationæ˜¯æŒ‡å•å¼ å›¾ç‰‡çš„å•ä¸ªé€šé“å•ç‹¬è¿›è¡ŒNoramlizationæ“ä½œã€‚)ï¼š
$$
\mu_{nc}(x)= \frac{1}{HW}\sum_{h=1}^H\sum_{w=1}^Wx_{nchw}  \\
\sigma_{nc}(x)=\sqrt{ 
 \frac{1}{HW}\sum_{h=1}^H\sum_{w=1}^W(x_{nchw}-\mu_{nc}(x))^2  +\epsilon
}
$$


![](https://gitee.com/shilongshen/image-bad/raw/master/image/20200604113539.png)



> â€‹	BNå’ŒINçš„åŒºåˆ«ï¼š
>
> batch normæ˜¯å¯¹ä¸€ä¸ªbatché‡Œæ‰€æœ‰çš„å›¾ç‰‡çš„æ‰€æœ‰åƒç´ æ±‚å‡å€¼å’Œæ ‡å‡†å·®ã€‚è€Œinstance normæ˜¯å¯¹å•ä¸ªå›¾ç‰‡çš„æ‰€æœ‰åƒç´ æ±‚å‡å€¼å’Œæ ‡å‡†å·®ã€‚
>
> BNé€‚ç”¨äºåˆ¤åˆ«æ¨¡å‹ä¸­ï¼Œæ¯”å¦‚å›¾ç‰‡åˆ†ç±»æ¨¡å‹ã€‚å› ä¸ºBNæ³¨é‡å¯¹æ¯ä¸ªbatchè¿›è¡Œå½’ä¸€åŒ–ï¼Œä»è€Œä¿è¯æ•°æ®åˆ†å¸ƒçš„ä¸€è‡´æ€§ï¼Œè€Œåˆ¤åˆ«æ¨¡å‹çš„ç»“æœæ­£æ˜¯å–å†³äºæ•°æ®æ•´ä½“åˆ†å¸ƒã€‚ä½†æ˜¯BNå¯¹batchsizeçš„å¤§å°æ¯”è¾ƒæ•æ„Ÿï¼Œç”±äºæ¯æ¬¡è®¡ç®—å‡å€¼å’Œæ–¹å·®æ˜¯åœ¨ä¸€ä¸ªbatchä¸Šï¼Œæ‰€ä»¥å¦‚æœbatchsizeå¤ªå°ï¼Œåˆ™è®¡ç®—çš„å‡å€¼ã€æ–¹å·®ä¸è¶³ä»¥ä»£è¡¨æ•´ä¸ªæ•°æ®åˆ†å¸ƒï¼›
>
> INé€‚ç”¨äºç”Ÿæˆæ¨¡å‹ä¸­ï¼Œæ¯”å¦‚å›¾ç‰‡é£æ ¼è¿ç§»ã€‚å› ä¸ºå›¾ç‰‡ç”Ÿæˆçš„ç»“æœä¸»è¦ä¾èµ–äºæŸä¸ªå›¾åƒå®ä¾‹ï¼Œæ‰€ä»¥å¯¹æ•´ä¸ªbatchå½’ä¸€åŒ–ä¸é€‚åˆå›¾åƒé£æ ¼åŒ–ä¸­ï¼Œåœ¨é£æ ¼è¿ç§»ä¸­ä½¿ç”¨Instance Normalizationä¸ä»…å¯ä»¥åŠ é€Ÿæ¨¡å‹æ”¶æ•›ï¼Œå¹¶ä¸”å¯ä»¥ä¿æŒæ¯ä¸ªå›¾åƒå®ä¾‹ä¹‹é—´çš„ç‹¬ç«‹**ã€‚**
>
> â€‹	è¡¥å……ï¼š
>
> Ioffeå’ŒSzegedyå°†BNå±‚å¼•å…¥äº†ç¥ç»ç½‘ç»œä¸­ï¼Œå…¶èƒ½å¤Ÿé€šè¿‡ç‰¹å¾å½’ä¸€åŒ–åŠ å¿«å‰é¦ˆç¥ç»ç½‘ç»œçš„è®­ç»ƒè¿‡ç¨‹ã€‚BNå±‚æœ€åˆç”¨äºåˆ¤åˆ«å™¨çš„è®­ç»ƒï¼Œä½†æ˜¯åœ¨ç”Ÿæˆæ¨¡å‹ä¸­ä¹ŸåŒæ ·æœ‰æ•ˆã€‚



**INé€šè¿‡å½’ä¸€åŒ–feature statisticsï¼ˆå¹³å‡å€¼å’Œæ–¹å·®ï¼‰æ¥è¿›è¡Œé£æ ¼å½’ä¸€åŒ–**ã€‚å› ä¸ºBNå½’ä¸€åŒ–ä¸€ä¸ªbatchçš„æ ·æœ¬çš„feature statisticsï¼Œå› æ­¤å¯ä»¥ç›´è§‚ç†è§£ä¸ºå°†ä¸€ä¸ªbatchçš„æ ·æœ¬å½’ä¸€åŒ–ä¸ºåŒä¸€é£æ ¼ã€‚å½“åœ¨é£æ ¼è¿ç§»ä¸­ï¼Œä¸åŒçš„å›¾ç‰‡åº”è¯¥å…·æœ‰ä¸åŒçš„é£æ ¼ã€‚è€ŒINå¯ä»¥å°†æ¯å¼ å›¾ç‰‡çš„é£æ ¼è½¬æ¢ä¸ºç›®æ ‡çš„é£æ ¼ï¼Œä»è¿™ä¸€è§’åº¦å‡ºå‘INï¼ˆå¯¹INä¸­çš„$\gamma$å’Œ$\beta$é€‰æ‹©ä¸åŒçš„å‚æ•°è¿›è¡Œå½’ä¸€åŒ–æ“ä½œï¼‰çš„æœ‰æ•ˆæ€§ä¹Ÿå¯ä»¥è§£é‡Šæ¸…æ¥šï¼š<u>ä¸åŒçš„ä»¿å°„å‚æ•°å¯ä»¥å°†feature statisticså½’ä¸€åŒ–åˆ°ä¸åŒçš„å€¼ï¼Œå› æ­¤å¯ä»¥å°†ç”Ÿæˆå›¾ç‰‡å½’ä¸€åŒ–ä¸åŒçš„é£æ ¼</u>ã€‚

> ä¸åŒçš„ä»¿å°„å‚æ•°å¯¹åº”ä¸åŒçš„é£æ ¼ã€‚

å¤§é‡çš„ç ”ç©¶å·¥ä½œè¡¨æ˜å·ç§¯å±‚çš„ç‰¹å¾ç»Ÿè®¡ç‰¹æ€§èƒ½å¤Ÿæ•è·å›¾åƒçš„é£æ ¼ä¿¡æ¯ã€‚æˆ‘ä»¬è®¤ä¸ºINé€šè¿‡å½’ä¸€åŒ–ç‰¹å¾ç»Ÿè®¡ç‰¹æ€§ï¼ˆå‡å€¼å’Œæ–¹å·®ï¼‰ï¼Œæ¥è¿›è¡Œé£æ ¼ä¿¡æ¯çš„å½’ä¸€åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ç”Ÿæˆç½‘ç»œçš„ç‰¹å¾ç»Ÿè®¡ç‰¹æ€§èƒ½å¤Ÿæ§åˆ¶ç”Ÿæˆå›¾åƒçš„é£æ ¼ã€‚

#### 4 Adaptive Instance Normalizationï¼ˆAdaINï¼‰

INé€šè¿‡ä¸€ç»„ç‰¹å®šçš„ä»¿å°„å‚æ•°å°†è¾“å…¥å›¾åƒå½’ä¸€åŒ–ä¸ºå•ä¸€çš„é£æ ¼ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è‡ªé€‚åº”ä»¿å°„å‚æ•°æ¥å°†è¾“å…¥å›¾åƒè½¬æ¢ä¸ºä»»æ„é£æ ¼ï¼ˆAdaINï¼‰ã€‚

AdaINçš„è¾“å…¥ä¸ºå†…å®¹$x$å’Œé£æ ¼$y$ï¼Œå¹¶å°†$x$å’Œ$y$çš„å‡å€¼å’Œæ–¹å·®è¿›è¡ŒåŒ¹é…ã€‚AdaINä¸­ä¸éœ€è¦è¿›è¡Œä»¿å°„å‚æ•°çš„å­¦ä¹ ï¼Œè€Œæ˜¯é€šè¿‡$y$æ¥è®¡ç®—ä»¿å°„å‚æ•°ï¼š
$$
AdaIN(x,y)=\sigma(y){\large(} \frac{x-\mu(x)}{\sigma(x)}  {\large)}+\mu(y)
$$
**å…¶ä¸­æˆ‘ä»¬æ ¹æ®$\sigma(y)$æ¥ç¼©æ”¾$x$ï¼Œæ ¹æ®$\mu(y)$æ¥å¹³ç§»$x$ï¼Œç›®çš„æ˜¯å°†$x$å’Œ$y$çš„å‡å€¼å’Œæ–¹å·®è¿›è¡ŒåŒ¹é…**ã€‚AdaINé€šè¿‡åœ¨feature space ä¸­è½¬æ¢feature statisticsï¼ˆç‰¹åˆ«æ˜¯é€šé“æ–¹å‘çš„å‡å€¼å’Œæ–¹å·®ï¼‰æ¥è¿›è¡Œé£æ ¼è¿ç§»ï¼Œ

> ç»è¿‡å®éªŒç ”ç©¶ï¼Œé£æ ¼è½¬æ¢ä¸­çš„é£æ ¼ä¸INä¸­çš„ä»¿å°„å‚æ•°æœ‰å¾ˆå¤§å…³ç³»ï¼ŒAdaINæ‰©å±•äº†INçš„èƒ½åŠ›ï¼Œ<u>ä½¿ç”¨é£æ ¼å›¾åƒçš„å‡å€¼å’Œæ ‡å‡†å·®ä½œä¸ºä»¿å°„å‚æ•°</u>ï¼ŒåŸºäºè¿™æ ·ä¸€ä¸ªå‡è®¾ï¼š<u>ç»™å®šä»»æ„çš„ä»¿å°„å‚æ•°èƒ½å¤Ÿåˆæˆå…·æœ‰ä»»æ„é£æ ¼çš„å›¾åƒ</u>ã€‚
>
> AdaINå±‚ä¸BNã€INç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨ç½‘ç»œå†…éƒ¨æ”¹å˜feature mapçš„åˆ†å¸ƒï¼Œå³é€šè¿‡æ”¹å˜ä»¿å°„å‚æ•°æ¥æ”¹å˜feature mapçš„åˆ†å¸ƒä»¥æ­¤æ¥å®ç°é£æ ¼è¿ç§»ï¼Œæ‰€ä»¥å¯ä»¥æŠŠé£æ ¼è¿ç§»çš„ä»»åŠ¡äº¤ç»™AdaINï¼Œåœ¨ç½‘ç»œç»“æ„ä¸Šå®ç°å…¶ä»–çš„ä»»åŠ¡

#### 5 experimental

![](https://gitee.com/shilongshen/image-bad/raw/master/image/20200604200554.png)

style transfer network Tä»¥content image $c$å’Œarbitrary style image $s$ä½œä¸ºè¾“å…¥ï¼ŒTé‡‡ç”¨encoder-decoderç»“æ„ï¼Œå…¶ä¸­encoder $f$ä¸ºé¢„è®­ç»ƒçš„VGG-19çš„å‰å‡ å±‚ï¼ˆç›´åˆ° relu4_1ï¼‰,å°†$c$å’Œ$s$é€šè¿‡$f$ç¼–ç åé€å…¥AdaINï¼Œå¾—åˆ°target feature map $t$ï¼š
$$
t=AdaIN[f(c),f(s)]
$$
decoder $g$å°†$t$æ˜ å°„å›image spaceï¼Œäº§ç”Ÿé£æ ¼è¿ç§»å›¾ç‰‡$T(c,s)$:
$$
T(c,s)=g(t)
$$
ä½¿ç”¨é¢„è®­ç»ƒçš„VGG-19æ¥è®¡ç®—æŸå¤±å‡½æ•°ï¼š
$$
\mathcal{L}=\mathcal{L}_c+\lambda\mathcal{L}_s
$$
è¿™é‡Œä½¿ç”¨äº†$t$ä½œä¸ºcontent targetï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸€èˆ¬çš„content imageçš„feature responseã€‚åœ¨å®éªŒä¸­å‘ç°è¿™èƒ½å¤Ÿä½¿å¾—æ”¶æ•›é€Ÿåº¦ç¨å¾®å˜å¿«ã€‚
$$
\mathcal{L}_c=|| f(g(t))-t ||_2
$$
ç”±äºAdaINåªæ˜¯å°†style featureçš„å‡å€¼å’Œæ–¹å·®è¿›è¡Œäº†è½¬æ¢ï¼Œå› æ­¤style losséœ€è¦åŒ¹é…è¿™äº›ç»Ÿè®¡ç‰¹æ€§ã€‚
$$
\mathcal{L}_s=\sum_{i=1}^L|| \mu(\phi_i(g(t)))- \mu(\phi_i(s) ||_2\\+\sum_{i=1}^L|| \sigma(\phi_i(g(t)))- \sigma(\phi_i(s) ||_2
$$

#### 6 AdaINçš„pytorchå®ç°

~~~python
import torch


def calc_mean_std(feat, eps=1e-5):
    # eps is a small value added to the variance to avoid divide-by-zero.
    size = feat.size()
    assert (len(size) == 4)
    #è¾“å…¥çš„ç‰¹å¾å›¾ç»´åº¦ä¸ºï¼ˆNï¼ŒCï¼ŒHï¼ŒWï¼‰
    N, C = size[:2]#è¯»å–Nï¼ŒCçš„å¤§å°
    #feat.view(N, C, -1)å°†ç»´åº¦é‡æ„ä¸ºï¼ˆNï¼ŒCï¼ŒH*Wï¼‰
    #.var(dim=2)è®¡ç®—å•å¼ å›¾åƒå•ä¸ªé€šé“çš„æ–¹å·®
    feat_var = feat.view(N, C, -1).var(dim=2) + eps  # è®¡ç®—å•ä¸ªé€šé“çš„æ–¹å·®ï¼Œå†åŠ ä¸Šä¸€ä¸ªå°çš„åç§»é‡
    #æ­¤æ—¶print(feat_var.shape)
    #>>(N,C)
    #.varçš„æ“ä½œå°†dim=2çš„ç»´åº¦ç»™å–æ¶ˆäº†ï¼Œå°†ï¼ˆNï¼ŒCï¼ŒH*Wï¼‰->(N,C)
    #ç›¸å½“äºå°†å›¾åƒå‹æ‰äº†ï¼ŒäºŒç»´çŸ©é˜µä¸Šçš„æ¯ä¸€ä¸ªå…ƒç´ è¡¨ç¤ºå•å¼ å›¾åƒå•ä¸ªé€šé“çš„æ–¹å·®
    
    #.view(N, C, 1, 1)å°†(N,C)->(N,C,1,1)
    feat_std = feat_var.sqrt().view(N, C, 1, 1)  # è®¡ç®—æ ‡å‡†å·®ï¼Œæœ€ç»ˆéœ€è¦çš„æ˜¯æ ‡å‡†å·®
    
    #å‡å€¼åŒç†
    feat_mean = feat.view(N, C, -1).mean(dim=2).view(N, C, 1, 1)  # è®¡ç®—å‡å€¼
    return feat_mean, feat_std


def adaptive_instance_normalization(content_feat, style_feat):
    assert (content_feat.size()[:2] == style_feat.size()[:2])
    size = content_feat.size()
   
    style_mean, style_std = calc_mean_std(style_feat)#è®¡ç®—style å‡å€¼å’Œæ ‡å‡†å·®
 
    content_mean, content_std = calc_mean_std(content_feat)#è®¡ç®—content å‡å€¼å’Œæ ‡å‡†å·®
   
    
    #content_mean.expand(size)å°†(N,C,1,1)çš„å‡å€¼çŸ©é˜µä¸Šå‡ä¸ºï¼ˆNï¼ŒCï¼ŒHï¼ŒWï¼‰
    #å¯¹åº”çš„å•ä¸ªé€šé“çš„æ¯ä¸€ä¸ªpixelçš„æ•°å€¼æ˜¯ç›¸åŒçš„
    #å¯¹å•å¼ å›¾åƒçš„å•ä¸ªé€šé“è¿›è¡Œå½’ä¸€åŒ–å¤„ç†
    normalized_feat = (content_feat - content_mean.expand(
        size)) / content_std.expand(size)
    
    # ä½¿ç”¨style codeè¿›è¡Œç¼©æ”¾å’Œå¹³ç§»
    #å¯¹åº”çš„content feature,ä¸€ä¸ªé€šé“éœ€è¦ä¸¤ä¸ªstyleå‚æ•°,ä¸€å…±éœ€è¦N*2*Cä¸ªå‚æ•°
    return normalized_feat * style_std.expand(size) + style_mean.expand(size)


#æµ‹è¯•éƒ¨åˆ†
con_feat = torch.randn(2, 2, 2, 2)
# print(con_feat.size())
sty_feat = torch.randn(2, 2, 2, 2)
# print(sty_feat)
adaptive_instance_normalization(con_feat, sty_feat)
# print(out)

~~~

<img src="https://gitee.com/shilongshen/image-bad/raw/master/img/20200723192510.jpg" style="zoom:50%;" />
